{% if CONSUL_VM_EC2_SERVER_COUNT == 1 %}
bootstrap = true
{% else %}
bootstrap_expect = {{ CONSUL_VM_EC2_SERVER_COUNT }}
{% endif %}

server = true

node_name = "{{ inventory_hostname }}"
datacenter = "{{ CONSUL_VM_EC2_DATACENTER }}"

data_dir = "/opt/consul/data-dir"
license_path = "/opt/consul/license/venus.nothing"

client_addr = "0.0.0.0"
bind_addr = "0.0.0.0"

retry_join={{ groups[DC_NODES] | map('extract', hostvars, 'private_ip') | map(attribute='stdout', default='') | list | select }}

advertise_addr = {% raw %} "{{ GetPrivateIP }}" {% endraw %}

ui_config {
  enabled = true
}

connect {
  enabled = true
}

acl {
  enabled = true 
  default_policy = "deny"
  enable_token_persistence = true
}

