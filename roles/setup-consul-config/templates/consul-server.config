{% if CONSUL_VM_EC2_SERVER_COUNT == 1 %}
bootstrap = true
{% else %}
bootstrap_expect = {{ CONSUL_VM_EC2_SERVER_COUNT }}
{% endif %}

server = true

node_name = "{{ inventory_hostname }}"
datacenter = "{{ CONSUL_VM_EC2_DATACENTER }}"

data_dir = "/opt/consul/data-dir"
license_path = "/opt/consul/license/venus.nothing"

encrypt = "{{ groups[DC_MGMT] | map('extract', hostvars, 'gossip_encrypt_' + DC_NORM) | list | join('') }}"

client_addr = "0.0.0.0"
bind_addr = "0.0.0.0"

retry_join={{ groups[DC_NODES] | map('extract', hostvars, 'private_ip') | map(attribute='stdout', default='') | list | select }}

advertise_addr = {% raw %} "{{ GetPrivateIP }}" {% endraw %}

ui_config {
  enabled = true
}

connect {
  enabled = true
}

acl {
  enabled = true 
  default_policy = "deny"
  enable_token_persistence = true
}

ports {
  http = -1
  https = 8501
  grpc = -1
  grpc_tls = 8503
}

tls {
  defaults {
    ca_file = "/opt/consul/tls/consul-agent-ca.pem"
    cert_file = "/opt/consul/tls/{{ DC_NAME }}-server-consul-0.pem"
    key_file = "/opt/consul/tls/{{ DC_NAME }}-server-consul-0-key.pem"
    verify_server_hostname = true
    verify_incoming = true
    verify_outgoing = true
  }

  https {
    verify_incoming = false
  }
}


enable_central_service_config = true
